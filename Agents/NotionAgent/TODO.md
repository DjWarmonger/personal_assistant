# FIXME:

## Query database fail - database is cached with block: prefix

This is actually a page and not a database

* Investigate task message passed from Planner to Notion Agent

## Notion Agent uses page id as task id for CompleteTask

Notion Agent correctly realizes that page is already added. But then tries to call "CompleteTask" with page id instead of task id,

## Action status message in Agent context is incorrect:

* Action name shouldn't start from "FAILED"
* Task status is 'completed' but it's FAILED
* Resolution is generated by agent, should be empty if action failed

Action taken: FAILED     qbms8hEr3i1TZh0AJgzRdf62 - complete_task (qbms8hEr3i1TZh0AJgzRdf62) with args: {'task_id': '4fa780c8df7746ff83500cd7d504c3d7', 'status': 'completed', 'resolution': "Added TODO page to favourites and displayed today's tasks from...

## Wrtiter received only one block:

All visited blocks (id : content):
```json
2 : {'object': 'list', 'results': [{'object': 'block', 'id': 1, 'parent': {'page_id': 22}, 'has_children': False, 'child_database': {'title': 'Agent Notion - Zadania'}}, {'object': 'block', 'id': 42, 'parent': {'page_id': 22}, 'has_children': False, 'bookmark': {'caption': [{'text': {'content': 'Moja integracja'}}]}}, {'object': 'block', 'id': 43, 'parent': {'page_id': 22}, 'has_children': True, 'heading_3': {'rich_text': [{'text': {'content': 'Zalety'}}], 'is_toggleable': True, 'color': 'default'}}, {'object': 'block', 'id': 44, 'parent': {'page_id': 22}, 'has_children': True, 'heading_3': {'rich_text': [{'text': {'content': 'Scenariusze użycia'}}], 'is_toggleable': True, 'color': 'default'}}, {'object': 'block', 'id': 45, 'parent': {'page_id': 22}, 'has_children': True, 'heading_3': {'rich_text': [{'text': {'content': 'Dedykowany agent samodzielnie przeglądający Notion'}}], 'is_toggleable': True, 'color': 'default'}}, {'object': 'block', 'id': 46, 'parent': {'page_id': 22}, 'has_children': True, 'heading_3': {'rich_text': [{'text': {'content': 'Integracja z YouTube'}}], 'is_toggleable': True, 'color': 'default'}}, {'object': 'block', 'id': 47, 'parent': {'page_id': 22}, 'has_children': False, 'paragraph': {'color': 'default'}}, {'object': 'block', 'id': 48, 'parent': {'page_id': 22}, 'has_children': False, 'paragraph': {'color': 'default'}}, {'object': 'block', 'id': 49, 'parent': {'page_id': 22}, 'has_children': False, 'paragraph': {'color': 'default'}}], 'has_more': False}`
```

This happened only once when adding page to favourites. Subsequent tasks to get all page content worked fine.

## Weird log at successfdul attempt to add page to favourites:


2025-06-08 08:32:23,817 - DEBUG      - Added to favourites : 123e4567e89b12d3a456426614174000
2025-06-08 08:32:23,817 - DEBUG      - Removed from favourites : 123e4567e89b12d3a456426614174000
2025-06-08 08:32:23,817 - COMMON     - Favourites:[]
2025-06-08 08:32:24,329 - DEBUG      - Processed and stored page 1
2025-06-08 08:32:24,718 - DEBUG      - Processed and stored database 1
2025-06-08 08:32:25,067 - ERROR      - 404
2025-06-08 08:32:34,629 - ERROR      - Identifier 'invalid-uuid' is not a valid URL, UUID, or integer ID.
2025-06-08 08:32:34,629 - ERROR      - Could not convert invalid-uuid to CustomUUID in get_block_children
2025-06-08 08:32:34,636 - ERROR      - Identifier 'invalid-uuid' is not a valid URL, UUID, or integer ID.
2025-06-08 08:32:34,636 - ERROR      - Could not convert invalid-uuid to CustomUUID in get_all_children_recursively
2025-06-08 08:32:35,238 - ERROR      - 404

# Optimizations

## Block Filtering Optimizations

- [ ]  **Performance optimizations**:
    - [ ]  Cache filtered versions for frequently requested filter combinations
    - [ ]  Implement lazy filtering for large block trees
    - [ ]  Add metrics for filtering performance

## Task optimization

- Make Taks use custom UUID class
- Make Task print shorter format of uuid without dashes

```
Unsolved tasks:Task Id: b341b0b2-03e3-4491-b2fc-4a05a0fbc501 - Wyświetl wszystkie zadania z dzisiejszej listy TODO na stronie o UUID 4fa780c8df7746ff83500cd7d504c3d7
```

# Misc features

# Extra agent tools

## Tool that shows X favourite pages

- Do not give it to Agent yet
- Allow paging?
- Create unit tests

## Limit number of loop iteration for Agent

- Start with Notion Agent
- Add iteration count to context, as last message
- Mention it in system prompt?

# Marimo dashboard

## Add static field that shows cache hit ratio

## Open logs from multiple tasks ran in parallel in separate tabs

- Make sure text doesn't go out of tab header

## Fix task browser label so it can hold long text (currently it doesn't fit and extends beyond boundaries)

## Create new task in Marimo

- Get all tasks from actual database: https://www.notion.so/11d9efeb667680ed98cffaef689b9cf1?v=65ea497489ca4dd4a58998f5b1242988
